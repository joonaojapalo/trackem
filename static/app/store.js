// Generated by CoffeeScript 1.10.0
(function() {
  define(["underscore", "marionette"], function(_, Marionette) {
    var Store;
    Store = Marionette.Object.extend({
      fetchableClass: null,
      initialize: function(options) {
        _.bindAll(this, "setup");
        this.dfd = null;
        return this.fetchable = new this.fetchableClass;
      },
      setup: function() {
        return null;
      },
      _fetch: function() {
        var _this, deps, depsPromise, dfd;
        dfd = new $.Deferred;
        deps = _.result(this, "setupDeps", []);
        depsPromise = $.when.apply(_.map(deps, function(dep) {
          return dep.fetch();
        }));
        _this = this;
        depsPromise.done(function() {
          var promise;
          _this.setup(arguments);
          promise = _this.fetchable.fetch();
          promise.done(function() {
            return dfd.resolve(_this.fetchable);
          });
          return promise.fail(function() {
            return dfd.reject();
          });
        });
        depsPromise.fail(function() {
          return dfd.reject();
        });
        return dfd;
      },
      fetch: function() {
        if (!this.dfd) {
          this.dfd = this._fetch();
        }
        return this.dfd.promise();
      },
      refetch: function() {
        this.dfd = null;
        return this.fetch;
      }
    });
    return Store;
  });

}).call(this);
