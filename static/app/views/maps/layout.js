// Generated by CoffeeScript 1.10.0
(function() {
  define(["jquery", "radio", "underscore", "marionette", "text!templates/maps/layout", "app/state", "views/maps/dropdown", "views/maps/edit", "views/maps/empty", "widgets/loader", "stores/maps"], function($, Radio, _, Marionette, MapsLayoutTemplate, state, Dropdown, EditMapView, EmptyMapView, LoaderView, mapsStore) {
    var MapsLayout, mapsChannel;
    mapsChannel = Radio.channel("maps");
    return MapsLayout = Marionette.LayoutView.extend({
      template: MapsLayoutTemplate,
      regions: {
        mapsRegion: '[data-region="maps"]',
        editMapRegion: '[data-region="edit-map"]'
      },
      ui: {
        create: '[data-action="create"]',
        inputNewMapName: '[name="new-map-name"]'
      },
      events: {
        "click @ui.create": "onCreateClick"
      },
      initialize: function(options) {
        var _this, ref;
        _.bindAll(this, "onSelect");
        this.state = new Backbone.Model({
          mapId: parseInt((ref = options.mapId) != null ? ref : null)
        });
        _this = this;
        return mapsChannel.on("delete", function() {
          return _this.editMapRegion.show(new EmptyMapView);
        });
      },
      onDestroy: function() {
        mapsChannel.off("delete");
        return mapsChannel.off("map:select");
      },
      onBeforeShow: function() {
        var _this;
        mapsChannel.on("map:select", this.onSelect);
        _this = this;
        return mapsStore.fetch().done(function(maps) {
          return _this.triggerMethod("fetch", maps);
        });
      },
      onFetch: function(maps) {
        var map;
        this.mapsRegion.show(new Dropdown({
          collection: maps
        }));
        map = maps.findWhere({
          id: this.state.get("mapId")
        });
        if (!map) {
          return this.editMapRegion.show(new EmptyMapView);
        } else {
          return this.onSelect(map);
        }
      },
      onSelect: function(map) {
        Backbone.history.navigate("maps/" + (map.get('id')));
        return this.editMapRegion.show(new EditMapView({
          model: map
        }));
      },
      onCreateClick: function() {
        var newMapName;
        newMapName = this.ui.inputNewMapName.val();
        if (!newMapName) {
          return;
        }
        return mapsStore.fetch().done(function(maps) {
          var mapAttrs, promise;
          mapAttrs = {
            name: newMapName
          };
          return promise = maps.create(mapAttrs, {
            wait: true,
            success: function(model) {
              return mapsChannel.trigger("map:create", model);
            }
          });
        });
      }
    });
  });

}).call(this);
